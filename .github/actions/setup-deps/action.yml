name: CASA Installation
description: "Install CASA dependencies and setup"
runs:
  using: "composite"
  steps:
  - name: Install dependencies
    run: |
      sudo apt-get update
      sudo apt-get install -y wget tar xz-utils perl
    shell: bash

  - name: Set up CASA environment variables
    run: |
      echo "CASABASE=casa-6.6.5-31-py3.10.el8" >> $GITHUB_ENV
      echo "HOME=$GITHUB_WORKSPACE/casa" >> $GITHUB_ENV
    shell: bash

  - name: Create CASA directory
    run: |
      mkdir -p $GITHUB_WORKSPACE/casa
      cd $GITHUB_WORKSPACE/casa
    shell: bash

  - name: Download CASA
    working-directory: ${{ github.workspace }}/casa
    run: |
      wget --content-disposition https://casa.nrao.edu/download/distro/casa/release/rhel/${CASABASE}.tar.xz
    shell: bash

  - name: Extract CASA
    working-directory: ${{ github.workspace }}/casa
    run: |
      tar -xvf ${CASABASE}.tar.xz
      rm -f ${CASABASE}.tar.xz
    shell: bash

  - name: Set up CASA PATH
    run: |
      echo "$GITHUB_WORKSPACE/casa/${CASABASE}/bin" >> $GITHUB_PATH
    shell: bash

  - name: Initialize CASA data directory
    run: |
      mkdir -p $HOME/.casa/data
    shell: bash

  - name: Initialize CASA (download data)
    working-directory: ${{ github.workspace }}/casa
    run: |
      casa --log2term -c "exit"
    shell: bash

  - name: Verify CASA installation
    run: |
      casa --version
    shell: bash